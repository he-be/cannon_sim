## Shooting Method実装のデバッグ指示書

**目的:** 現在発生しているShooting Methodの振動と発散の問題を解決し、3次元空間内の目標へ正確に命中させるための安定した解（仰角・方位角）を導出する。

**現状の分析:**
レポートから、問題の根源はパラメータ（減衰率、補正上限など）の調整ミスではなく、**アルゴリズムの前提となる物理的・数学的モデルの誤り**にある可能性が極めて高い。特に、以下の2点が致命的な欠陥となっている可能性が考えられる。

1.  **誤差ベクトルの定義**: 「弾道が目標高度を通過した地点」を終点としており、目標の水平位置（X, Y）を考慮していない。これでは目標からどれだけ離れていても「高度さえ合えば良い」という誤った情報がアルゴリズムに与えられ、正しい解に収束するはずがない。
2.  **Jacobian行列の計算**: 方位角が-113°から246°へと真逆に補正されている点は、座標系の不整合や符号ミスなど、Jacobian行列の計算に重大なバグが存在することを示唆している。

以下の手順に従い、根本原因を特定し、修正せよ。

---

### **ステップ1：誤差ベクトル（F）の定義を修正する**

現在の実装における最も重大な論理的誤りは、誤差ベクトルの定義方法にある。これを修正しない限り、後続のステップは意味をなさない。

**現状の誤った定義:**
弾道が目標高度 $Z_t$ を通過した時点の弾着点 $P_{sim}$ と、目標位置 $P_t$ との差を誤差としている。

**正しい定義:**
解くべき問題は「特定の飛翔時間 $t_{flight}$ 後に、弾が目標位置 $P_t$ に到達すること」である。したがって、誤差ベクトルは**時間**を基準に定義する必要がある。

**提案する修正案（時間ベースでの誤差評価）:**

1.  まず、**弾道が目標の水平距離（XY平面上での距離）に到達するまでの飛翔時間 $t_{impact}$** を計算する。
    - シミュレーションをステップ実行し、各時点 $t$ での弾の位置 $P_{sim}(t) = (X_{sim}(t), Y_{sim}(t), Z_{sim}(t))$ を求める。
    - 原点からの水平距離 $D_{sim}(t) = \sqrt{X_{sim}(t)^2 + Y_{sim}(t)^2}$ を計算する。
    - 目標の水平距離 $D_t = \sqrt{X_t^2 + Y_t^2}$ （レポートの例では約15km）と比較する。
    - $D_{sim}(t)$ が $D_t$ と一致する（または通過する）時刻を $t_{impact}$ として特定する。この際、2点間の線形補間を行い、正確な $t_{impact}$ を求めることが望ましい。

2.  その時刻 $t_{impact}$ における**弾の3次元座標 $P_{sim}(t_{impact})$** を計算する。

3.  **誤差ベクトル $F$** を、目標位置 $P_t$ と $P_{sim}(t_{impact})$ の差として定義する。
    $$
    F = P_{sim}(t_{impact}) - P_t = \begin{pmatrix} X_{sim}(t_{impact}) - X_t \\ Y_{sim}(t_{impact}) - Y_t \\ Z_{sim}(t_{impact}) - Z_t \end{pmatrix}
    $$

この修正により、アルゴリズムは「目標と同じ水平距離まで飛んだ時に、目標と同じ場所にいるか」という、物理的に意味のある誤差を最小化しようと動作するようになる。

---

### **ステップ2：Jacobian行列（J）の計算を検証する**

誤差ベクトルの定義を修正した後、次にNewton-Raphson法の心臓部であるJacobian行列の計算を検証する。方位角が反転する問題は、ほぼ確実にここに原因がある。

Jacobian行列 $J$ は、入力変数（方位角 $Az$, 仰角 $El$）の微小変化が出力（誤差ベクトル $F$）にどう影響するかを示す。

$$
J = \begin{pmatrix}
\frac{\partial F_x}{\partial Az} & \frac{\partial F_x}{\partial El} \\
\frac{\partial F_y}{\partial Az} & \frac{\partial F_y}{\partial El} \\
\frac{\partial F_z}{\partial Az} & \frac{\partial F_z}{\partial El}
\end{pmatrix}
$$

**検証手順:**
数値微分が正しく実装されているか、手動で確認する。

1.  **基準値の計算:**
    ある角度 $(\text{Az}_0, \text{El}_0)$ を設定し、ステップ1で修正したロジックで誤差ベクトル $F_0 = F(\text{Az}_0, \text{El}_0)$ を計算する。

2.  **仰角（Elevation）の偏微分検証:**
    - 仰角のみを微小量 $\Delta\text{El}$ （例：0.01°）だけ動かし、$F_1 = F(\text{Az}_0, \text{El}_0 + \Delta\text{El})$ を計算する。
    - 差分ベクトル $\Delta F_{El} = F_1 - F_0$ を計算する。
    - Jacobianの2列目の理論値は $\frac{\Delta F_{El}}{\Delta\text{El}}$ となる。
    - **現在のコードで計算されたJacobianの2列目と、上記で手計算した理論値が一致するか確認せよ。** 符号、スケール、方向がすべて正しいかチェックする。

3.  **方位角（Azimuth）の偏微分検証:**
    - 方位角のみを微小量 $\Delta\text{Az}$ だけ動かし、$F_2 = F(\text{Az}_0 + \Delta\text{Az}, \text{El}_0)$ を計算する。
    - 差分ベクトル $\Delta F_{Az} = F_2 - F_0$ を計算する。
    - Jacobianの1列目の理論値は $\frac{\Delta F_{Az}}{\Delta\text{Az}}$ となる。
    - **現在のコードで計算されたJacobianの1列目と、この理論値が一致するか確認せよ。** 方位角が-113°から246°に飛ぶ問題は、ここで符号が反転しているか、`atan2`等の関数の扱いを間違えている可能性が高い。特に座標系の定義（右手系/左手系、Y-up/Z-up）がシミュレーション全体で一貫しているか再確認すること。

---

### **ステップ3：Newton-Raphsonの更新ステップを検証する**

誤差ベクトル $F$ とJacobian行列 $J$ が正しければ、最後に角度の更新ステップを確認する。

過決定問題（3つの誤差、2つの変数）を解くため、最小二乗法を用いるのが一般的である。更新量 $\Delta \vec{x} = (\Delta \text{Az}, \Delta \text{El})^T$ は、正規方程式を用いて以下のように計算される。

$$\Delta \vec{x} = - (J^T J)^{-1} J^T F$$

**検証項目:**

1.  **線形代数ライブラリの確認:** この計算を正しく行っているか確認する。$(J^T J)$ の逆行列を計算し、行列の乗算が正しい順序で行われているかコードを一行ずつ追うこと。
2.  **更新の適用:** 計算された更新量 $\Delta\vec{x}$ を現在の角度に加算する処理 `currentAngle = currentAngle + dampingFactor * deltaAngle` を確認する。ここで単位（ラジアン/度）の変換ミスがないか、符号が正しいか再度確認する。

---

### **次のアクション**

以上の3ステップを上から順に、**一つずつ**実行し、各ステップでの検証結果を記録すること。ステップ1を修正せずにステップ2や3を検証しても意味がない。この体系的なアプローチにより、問題の根本原因が特定できるはずである。パラメータ調整（減衰率など）は、これら全てのステップが正しく機能することを確認した後に初めて行うべき最終調整である。
